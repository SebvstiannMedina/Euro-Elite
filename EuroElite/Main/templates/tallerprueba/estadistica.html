{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Estad칤sticas{% endblock %}

{% block content %}

<br>
<br>
<br>
<br>
<br>
<div class="container my-5">

  <!-- 游댳 Encabezado -->
  <div class="text-center mb-5">
    <h2 class="fw-bold text-primary">
      <i class="fa-solid fa-chart-line me-2"></i> Estad칤sticas de Ganancias
    </h2>
    <p class="text-muted">Resumen de rendimiento mensual de ventas y an치lisis de tendencias.</p>
  </div>

  <!-- 游댳 KPIs (res칰menes r치pidos) -->
  <div class="row g-4 mb-5">
    <div class="col-md-4">
      <div class="card shadow-sm border-0 rounded-4 p-4 text-center">
        <h6 class="text-muted">Ganancia Total</h6>
        <h3 class="fw-bold text-success">
          ${{ total|miles_chilenos }}
        </h3>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm border-0 rounded-4 p-4 text-center">
        <h6 class="text-muted">Mes con mayor venta</h6>
        <h3 class="fw-bold text-primary">{{ mes_max }}</h3>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm border-0 rounded-4 p-4 text-center">
        <h6 class="text-muted">Pedidos Registrados</h6>
        <h3 class="fw-bold text-dark">{{ cantidad_pedidos }}</h3>
      </div>
    </div>
  </div>

  <!-- 游댳 Gr치ficos -->
  <div class="row g-4">
    <!-- Gr치fico de barras -->
    <div class="col-lg-7">
      <div class="card shadow-lg border-0 rounded-4 p-4">
        <h5 class="fw-bold mb-3">Ganancias por Mes</h5>
        <canvas id="gananciasChart" height="150"></canvas>
      </div>
    </div>

    <!-- Gr치fico de l칤nea -->
    <div class="col-lg-5">
      <div class="card shadow-lg border-0 rounded-4 p-4">
        <h5 class="fw-bold mb-3">Tendencia</h5>
        <canvas id="tendenciaChart" height="150"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- FontAwesome (si no est치 ya en base.html) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = {{ labels|safe }};
  const values = {{ values|safe }};

  const ctx1 = document.getElementById('gananciasChart').getContext('2d');
  const ctx2 = document.getElementById('tendenciaChart').getContext('2d');

  // 游댯 Degradado para barras
  const gradient = ctx1.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, 'rgba(54, 162, 235, 0.9)');
  gradient.addColorStop(1, 'rgba(54, 162, 235, 0.2)');

  // 游늵 Gr치fico de barras
  new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Ganancias ($)',
        data: values,
        backgroundColor: gradient,
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 2,
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => "$ " + ctx.raw.toLocaleString("es-CL")
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: (value) => "$" + value.toLocaleString("es-CL")
          }
        }
      }
    }
  });

  // 游늳 Gr치fico de l칤nea
  new Chart(ctx2, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: "Tendencia de Ganancias",
        data: values,
        fill: true,
        borderColor: 'rgba(255, 99, 132, 1)',
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        tension: 0.3,
        pointBackgroundColor: 'rgba(255, 99, 132, 1)',
        pointRadius: 5,
        pointHoverRadius: 7
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true, position: 'top' },
        tooltip: {
          callbacks: {
            label: (ctx) => "$ " + ctx.raw.toLocaleString("es-CL")
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: (value) => "$" + value.toLocaleString("es-CL")
          }
        }
      }
    }
  });
</script>
{% endblock %}
