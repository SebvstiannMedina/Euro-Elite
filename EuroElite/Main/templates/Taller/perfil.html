{% extends 'base.html' %}
{% load static %}
{% block title %}Mi perfil - Euro Elite{% endblock %}
{% block content %}

<br><br><br><br><br><br>

<div class="container my-4 profile-wrapper">
  <div class="row">
    <!-- Sidebar -->
    <aside class="col-12 col-md-3 mb-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-1">Hola, <span>{{ user.first_name }}</span></h5>
          <p class="text-muted" style="font-size: .9rem;">Accede a toda la información de tu perfil</p>
          <div class="list-group list-group-flush mt-3">
            <a href="{% url 'perfil' %}" class="list-group-item list-group-item-action active">
              <i class="fas fa-id-card me-2"></i> Mis datos
            </a>
            <a href="{% url 'password_reset' %}" class="list-group-item list-group-item-action">
              <i class="fas fa-lock me-2"></i> Contraseña
            </a>
            <a href="{% url 'mis_citas' %}" class="list-group-item list-group-item-action">
              <i class="fas fa-calendar-alt me-2"></i> Mis citas
            </a>
            <a href="{% url 'mis_pedidos' %}" class="list-group-item list-group-item-action">
              <i class="fas fa-shopping-bag me-2"></i> Mis compras
            </a>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main content -->
    <section class="col-12 col-md-9">
      <h3>Mis datos</h3>
      <div class="card shadow-sm p-3">
        <form method="post" id="perfilForm" onsubmit="return validateForm(event)" novalidate>
          {% csrf_token %}
          <div class="row gy-3">
            <!-- Datos personales -->
            <div class="col-12 col-md-6">
              <label for="{{ form.first_name.id_for_label }}" class="form-label fw-semibold text-muted">Nombre</label>
              {{ form.first_name }}
              <div class="text-danger small d-none" data-feedback="first_name"></div>
              {% if form.first_name.errors %}
                <div class="text-danger small">{{ form.first_name.errors }}</div>
              {% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label for="{{ form.last_name.id_for_label }}" class="form-label fw-semibold text-muted">Apellido</label>
              {{ form.last_name }}
              <div class="text-danger small d-none" data-feedback="last_name"></div>
              {% if form.last_name.errors %}
                <div class="text-danger small">{{ form.last_name.errors }}</div>
              {% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label for="{{ form.email.id_for_label }}" class="form-label fw-semibold text-muted">Correo electrónico</label>
              {{ form.email }}
              <div class="text-danger small d-none" data-feedback="email"></div>
              {% if form.email.errors %}
                <div class="text-danger small">{{ form.email.errors }}</div>
              {% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label for="rut" class="form-label fw-semibold text-muted">RUT</label>
              <input id="rut" name="rut" type="text" class="form-control" value="{{ form.rut.value|default:'' }}" placeholder="Ej: 12.345.678-9">
              <div id="rut-feedback" class="text-danger small d-none"></div>
              {% if form.rut.errors %}
                <div class="text-danger small">{{ form.rut.errors }}</div>
              {% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label for="telefono" class="form-label fw-semibold text-muted">Teléfono</label>
              <div class="input-group">
                <span class="input-group-text">+56 9</span>
                <input id="telefono" name="telefono" type="text" class="form-control" required maxlength="8" pattern="[0-9]{8}" autocomplete="tel" inputmode="numeric" value="{{ form.telefono.value|default:'' }}" placeholder="Ej: 12345678">
              </div>
              <div id="telefono-feedback" class="text-danger small d-none"></div>
              {% if form.telefono.errors %}
                <div class="text-danger small">{{ form.telefono.errors }}</div>
              {% endif %}
            </div>

            <!-- Dirección -->
            <hr class="mt-4 mb-2">
            <h5 class="mb-3">Dirección</h5>
            <div class="col-12 col-md-6">
              <label for="linea1" class="form-label fw-semibold text-muted">Calle / Dirección</label>
              <input type="text" name="linea1" id="linea1" 
                     class="form-control" required minlength="5" maxlength="120"
                     value="{{ direccion_form.linea1.value|default:'' }}"
                     placeholder="Ej: Av. Libertador 123, Depto 45">
              <div class="text-danger small d-none" data-feedback="linea1"></div>
              {% if direccion_form.linea1.errors %}
                <div class="text-danger small">{{ direccion_form.linea1.errors }}</div>
              {% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label for="linea2" class="form-label fw-semibold text-muted">Departamento / Oficina <span class="text-muted small">(opcional)</span></label>
              <input type="text" name="linea2" id="linea2" class="form-control" maxlength="120" 
                     placeholder="Ej: Depto 101" value="{{ direccion_form.linea2.value|default:'' }}">
              <div class="text-danger small d-none" data-feedback="linea2"></div>
              {% if direccion_form.linea2.errors %}
                <div class="text-danger small">{{ direccion_form.linea2.errors }}</div>
              {% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label for="{{ direccion_form.region.id_for_label }}" class="form-label fw-semibold text-muted">Región *</label>
              {{ direccion_form.region }}
              <div class="text-danger small d-none" data-feedback="region"></div>
              {% if direccion_form.region.errors %}
                <div class="text-danger small">{{ direccion_form.region.errors }}</div>
              {% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label for="{{ direccion_form.comuna.id_for_label }}" class="form-label fw-semibold text-muted">Comuna *</label>
              {{ direccion_form.comuna }}
              <div class="text-danger small d-none" data-feedback="comuna"></div>
              {% if direccion_form.comuna.errors %}
                <div class="text-danger small">{{ direccion_form.comuna.errors }}</div>
              {% endif %}
            </div>
          </div>
          <!-- Botones -->
          <div class="mt-4 d-flex gap-2">
            <button id="perfilSubmit" type="submit" class="btn btn-success" disabled>Guardar cambios</button>
            <a href="{% url 'perfil' %}" class="btn btn-secondary">Cancelar</a>
          </div>
        </form>
      </div>
    </section>
  </div>
</div>

<script>
// Single, minimal validator for the profile form. External js/perfil.js only populates comunas.
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('perfilForm');
  const submitBtn = document.getElementById('perfilSubmit');
  if (!form || !submitBtn) return;

  const $ = (sel) => document.querySelector(sel);
  const fields = {
    first_name: { input: $('[name="first_name"]'), fb: document.querySelector('[data-feedback="first_name"]') },
    last_name:  { input: $('[name="last_name"]'),  fb: document.querySelector('[data-feedback="last_name"]') },
    email:      { input: $('[name="email"]'),      fb: document.querySelector('[data-feedback="email"]') },
    telefono:   { input: $('#telefono'),            fb: document.getElementById('telefono-feedback') },
    rut:        { input: $('#rut'),                 fb: document.getElementById('rut-feedback') },
    linea1:     { input: $('#linea1'),              fb: document.querySelector('[data-feedback="linea1"]') },
    region:     { input: $('[name="region"]'),     fb: document.querySelector('[data-feedback="region"]') },
    comuna:     { input: $('[name="comuna"]'),     fb: document.querySelector('[data-feedback="comuna"]') },
  };

  const txt = (s) => (s||'').toString().trim();
  const onlyDigits = (s) => (s||'').replace(/\D/g,'');

  function cleanRut(s){
    return (s||'').replace(/\./g,'').replace(/-/g,'').toUpperCase();
  }
  function computeDV(body){
    let sum=0, mul=2; for(let i=body.length-1;i>=0;i--){ sum += parseInt(body[i],10)*mul; mul = mul===7?2:mul+1; }
    const r = 11 - (sum % 11); return r===11?'0': r===10?'K': String(r);
  }
  function validRut(value){
    const c = cleanRut(value); if(c.length<2) return false; const body=c.slice(0,-1), dv=c.slice(-1);
    if(!/^[0-9]+$/.test(body)) return false; return computeDV(body)===dv;
  }

  function setError(fieldKey, message){
    const f = fields[fieldKey]; if(!f || !f.input) return true;
    const ok = !message; f.input.classList.toggle('is-invalid', !ok);
    if (f.fb) { f.fb.textContent = message||''; f.fb.classList.toggle('d-none', ok); }
    return ok;
  }

  function validate(){
    let ok = true;
    // Nombres
    const fn = txt(fields.first_name.input?.value); ok &&= setError('first_name', fn.length<3 ? 'Debes ingresar al menos 3 caracteres' : '');
    const ln = txt(fields.last_name.input?.value);  ok &&= setError('last_name',  ln.length<3 ? 'Debes ingresar al menos 3 caracteres' : '');
    // Email
    const em = txt(fields.email.input?.value).toLowerCase();
    ok &&= setError('email', (/^[^@\s]+@[^@\s]+\.[^@\s]{2,}$/.test(em) ? '' : 'Correo inválido'));
    // Teléfono (8 dígitos)
    const tel = onlyDigits(fields.telefono.input?.value); ok &&= setError('telefono', (tel.length===8?'':'Teléfono debe contener 8 dígitos'));
    // Dirección línea 1 (>=5)
    const l1 = txt(fields.linea1.input?.value); ok &&= setError('linea1', l1.length<5 ? 'La dirección debe tener al menos 5 caracteres' : '');
    // Región/Comuna
    const rg = txt(fields.region.input?.value); ok &&= setError('region', rg? '':'Debes seleccionar una región');
    const cm = txt(fields.comuna.input?.value); ok &&= setError('comuna', cm? '':'Debes seleccionar una comuna');
    // RUT requerido y válido
    const rutVal = txt(fields.rut.input?.value); ok &&= setError('rut', rutVal? (validRut(rutVal)?'':'RUT inválido') : 'Debes ingresar tu RUT');
    return ok;
  }

  function update(){
    const ok = validate();
    submitBtn.disabled = !ok;
    return ok;
  }

  // Wire listeners
  ['first_name','last_name','email','telefono','linea1','rut'].forEach(k=>{
    const i = fields[k].input; if(!i) return;
    i.addEventListener('input', update);
    i.addEventListener('blur', update);
  });
  ['region','comuna'].forEach(k=>{
    const i = fields[k].input; if(!i) return;
    i.addEventListener('change', update);
    i.addEventListener('blur', update);
  });

  // Initial validation (delayed to allow JS to populate comuna)
  setTimeout(update, 100);

  // Expose for onsubmit handler
  window.validateForm = function(e){
    const ok = update();
    if (!ok && e){ e.preventDefault(); e.stopPropagation(); }
    return ok;
  }
  
  // Make update function available globally for region.js
  window.updateSubmitButton = update;
});
</script>
<script src="{% static 'js/perfil.region.js' %}" defer></script>
<style>
  .profile-wrapper .card {
    border: 0;
    border-radius: 12px;
    box-shadow: var(--shadow);
    background: #fff;
  }
  .profile-wrapper .list-group-item {
    border: 0;
  }
</style>

<br><br><br><br><br><br>

{% endblock %}