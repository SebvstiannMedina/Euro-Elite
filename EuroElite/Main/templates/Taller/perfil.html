{% extends 'base.html' %}
{% load static %}
{% block title %}Mi perfil - Euro Elite{% endblock %}
{% block content %}

<br><br><br><br><br><br>

<div class="container my-4 profile-wrapper">
  <div class="row">
    <!-- Sidebar -->
    <aside class="col-12 col-md-3 mb-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-1">Hola, <span>{{ user.first_name }}</span></h5>
          <p class="text-muted" style="font-size: .9rem;">Accede a toda la información de tu perfil</p>
          <div class="list-group list-group-flush mt-3">
            <a href="{% url 'perfil' %}" class="list-group-item list-group-item-action active">
              <i class="fas fa-id-card me-2"></i> Mis datos
            </a>
            <a href="{% url 'password_reset' %}" class="list-group-item list-group-item-action">
              <i class="fas fa-lock me-2"></i> Contraseña
            </a>
            <a href="{% url 'mis_citas' %}" class="list-group-item list-group-item-action">
              <i class="fas fa-calendar-alt me-2"></i> Mis citas
            </a>
            <a href="{% url 'mis_pedidos' %}" class="list-group-item list-group-item-action">
              <i class="fas fa-shopping-bag me-2"></i> Mis compras
            </a>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main content -->
    <section class="col-12 col-md-9">
      <h3>Mis datos</h3>
      <div class="card shadow-sm p-3">
        <form method="post" id="perfilForm" onsubmit="return validateForm(event)" novalidate>
          {% csrf_token %}
          <div class="row gy-3">
            <!-- Datos personales -->
            <div class="col-12 col-md-6">
              <label for="{{ form.first_name.id_for_label }}" class="form-label fw-semibold text-muted">Nombre</label>
              {{ form.first_name }}
              <div class="text-danger small d-none" data-feedback="first_name"></div>
              {% if form.first_name.errors %}
                <div class="text-danger small">{{ form.first_name.errors }}</div>
              {% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label for="{{ form.last_name.id_for_label }}" class="form-label fw-semibold text-muted">Apellido</label>
              {{ form.last_name }}
              <div class="text-danger small d-none" data-feedback="last_name"></div>
              {% if form.last_name.errors %}
                <div class="text-danger small">{{ form.last_name.errors }}</div>
              {% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label for="{{ form.email.id_for_label }}" class="form-label fw-semibold text-muted">Correo electrónico</label>
              {{ form.email }}
              <div class="text-danger small d-none" data-feedback="email"></div>
              {% if form.email.errors %}
                <div class="text-danger small">{{ form.email.errors }}</div>
              {% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label for="rut" class="form-label fw-semibold text-muted">RUT</label>
              <input id="rut" name="rut" type="text" class="form-control" required value="{{ form.rut.value|default:'' }}" placeholder="Ej: 12.345.678-9">
              <div id="rut-feedback" class="text-danger small d-none"></div>
              {% if form.rut.errors %}
                <div class="text-danger small">{{ form.rut.errors }}</div>
              {% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label for="telefono" class="form-label fw-semibold text-muted">Teléfono</label>
              <div class="input-group">
                <span class="input-group-text">+56 9</span>
                <input id="telefono" name="telefono" type="text" class="form-control" required maxlength="8" pattern="[0-9]{8}" autocomplete="tel" inputmode="numeric" value="{{ form.telefono.value|default:'' }}" placeholder="Ej: 12345678">
              </div>
              <div id="telefono-feedback" class="text-danger small d-none"></div>
              {% if form.telefono.errors %}
                <div class="text-danger small">{{ form.telefono.errors }}</div>
              {% endif %}
            </div>

            <!-- Dirección -->
            <hr class="mt-4 mb-2">
            <h5 class="mb-3">Dirección</h5>
            <div class="col-12 col-md-6">
              <label for="{{ direccion_form.linea1.id_for_label }}" class="form-label fw-semibold text-muted">Calle / Dirección</label>
              {{ direccion_form.linea1 }}
              <div class="text-danger small d-none" data-feedback="linea1"></div>
              {% if direccion_form.linea1.errors %}
                <div class="text-danger small">{{ direccion_form.linea1.errors }}</div>
              {% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label for="{{ direccion_form.linea2.id_for_label }}" class="form-label fw-semibold text-muted">Departamento / Oficina <span class="text-muted small">(opcional)</span></label>
              <input type="text" name="{{ direccion_form.linea2.name }}" id="{{ direccion_form.linea2.id_for_label }}" class="form-control" maxlength="45" pattern="[A-Za-zÁÉÍÓÚÜÑáéíóúüñ0-9 ]{0,45}" placeholder="Ej: Depto 101" value="{{ direccion_form.linea2.value|default:'' }}" autocomplete="address-line2" inputmode="text" oninput="this.value=this.value.replace(/[^A-Za-zÁÉÍÓÚÜÑáéíóúüñ0-9 ]/g,'');">
              <div class="text-danger small d-none" data-feedback="linea2"></div>
              {% if direccion_form.linea2.errors %}
                <div class="text-danger small">{{ direccion_form.linea2.errors }}</div>
              {% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label for="{{ direccion_form.comuna.id_for_label }}" class="form-label fw-semibold text-muted">Comuna</label>
              {{ direccion_form.comuna }}
              {% if direccion_form.comuna.errors %}
                <div class="text-danger small">{{ direccion_form.comuna.errors }}</div>
              {% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label for="{{ direccion_form.region.id_for_label }}" class="form-label fw-semibold text-muted">Región</label>
              {{ direccion_form.region }}
              {% if direccion_form.region.errors %}
                <div class="text-danger small">{{ direccion_form.region.errors }}</div>
              {% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label for="{{ direccion_form.codigo_postal.id_for_label }}" class="form-label fw-semibold text-muted">Código Postal</label>
              {{ direccion_form.codigo_postal }}
              <div class="text-danger small d-none" data-feedback="codigo_postal"></div>
              {% if direccion_form.codigo_postal.errors %}
                <div class="text-danger small">{{ direccion_form.codigo_postal.errors }}</div>
              {% endif %}
            </div>
          </div>

          <!-- Botones -->
          <div class="mt-4 d-flex gap-2">
            <button id="perfilSubmit" type="submit" class="btn btn-success" disabled>Guardar cambios</button>
            <a href="{% url 'perfil' %}" class="btn btn-secondary">Cancelar</a>
          </div>
        </form>
      </div>
    </section>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const telefono = document.getElementById('telefono');
    const telefonoFeedback = document.getElementById('telefono-feedback');
    const rut = document.getElementById('rut');
    const rutFeedback = document.getElementById('rut-feedback');
    const submitBtn = document.getElementById('perfilSubmit');
    const firstNameInput = document.querySelector('[name="first_name"]');
    const lastNameInput = document.querySelector('[name="last_name"]');

    function getFeedbackFor(name) {
      return document.querySelector(`[data-feedback="${name}"]`);
    }

    function showTelefonoError(message) {
      telefonoFeedback.textContent = message;
      telefonoFeedback.classList.remove('d-none');
      telefono.classList.add('is-invalid');
    }

    function hideTelefonoError() {
      telefonoFeedback.textContent = '';
      telefonoFeedback.classList.add('d-none');
      telefono.classList.remove('is-invalid');
    }

    function showNameError(input, message) {
      const fb = getFeedbackFor(input.name);
      if (fb) {
        fb.textContent = message;
        fb.classList.remove('d-none');
      }
      input.classList.add('is-invalid');
    }

    function hideNameError(input) {
      const fb = getFeedbackFor(input.name);
      if (fb) {
        fb.textContent = '';
        fb.classList.add('d-none');
      }
      input.classList.remove('is-invalid');
    }

    function validateNameInput(input) {
      if (!input) return true;
      const value = (input.value || '').trim();
      if (!value) {
        showNameError(input, 'Debes rellenar este campo');
        return false;
      }
      if (/[0-9]/.test(value)) {
        showNameError(input, 'No puede contener números');
        return false;
      }
      if (value.length < 3) {
        showNameError(input, 'Debe tener al menos 3 caracteres');
        return false;
      }
      if (value.length > 25) {
        showNameError(input, 'No puede tener más de 25 caracteres');
        return false;
      }
      hideNameError(input);
      return true;
    }

    function validateTelefonoField() {
      const value = telefono.value.replace(/\D/g, '');
      if (!value) {
        showTelefonoError('Por favor ingresa tu número de teléfono para continuar.');
        return false;
      }
      if (value.length < 8) {
        showTelefonoError('El teléfono debe tener 8 dígitos.');
        return false;
      }
      hideTelefonoError();
      return true;
    }

    if (telefono) {
      telefono.addEventListener('input', function () {
        telefono.value = telefono.value.replace(/\D/g, '').slice(0, 8);
        validateTelefonoField();
        updateSubmitButton();
      });

      telefono.addEventListener('blur', function () {
        validateTelefonoField();
        updateSubmitButton();
      });

      telefono.addEventListener('paste', function (e) {
        setTimeout(function () {
          telefono.value = telefono.value.replace(/\D/g, '').slice(0, 8);
          validateTelefonoField();
          updateSubmitButton();
        }, 0);
      });

      validateTelefonoField();
    }

    function updateSubmitButton() {
      if (!submitBtn) return false;
      const firstOk = validateNameInput(firstNameInput);
      const lastOk = validateNameInput(lastNameInput);
      const telOk = validateTelefonoField();
      const rutOk = validateRut(rut);
        const emailField = document.querySelector('[name="email"]');
        const emailOk = validateEmailField(emailField);
        const allOk = firstOk && lastOk && telOk && rutOk && emailOk;
      submitBtn.disabled = !allOk;
      submitBtn.setAttribute('aria-disabled', String(!allOk));
      return allOk;
    }

      function validateEmailField(input) {
        if (!input) return true;
        const value = input.value.trim();
        const feedback = getFeedbackFor('email');
      
        if (!value) {
          if (feedback) {
            feedback.textContent = 'El correo electrónico es obligatorio';
            feedback.classList.remove('d-none');
          }
          input.classList.add('is-invalid');
          return false;
        }
      
        if (value.length < 5) {
          if (feedback) {
            feedback.textContent = 'El correo electrónico debe tener al menos 5 caracteres';
            feedback.classList.remove('d-none');
          }
          input.classList.add('is-invalid');
          return false;
        }
      
        if (value.length > 100) {
          if (feedback) {
            feedback.textContent = 'El correo electrónico no puede tener más de 100 caracteres';
            feedback.classList.remove('d-none');
          }
          input.classList.add('is-invalid');
          return false;
        }
      
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
          if (feedback) {
            feedback.textContent = 'Por favor ingrese un correo electrónico válido';
            feedback.classList.remove('d-none');
          }
          input.classList.add('is-invalid');
          return false;
        }
      
        if (feedback) {
          feedback.textContent = '';
          feedback.classList.add('d-none');
        }
        input.classList.remove('is-invalid');
        return true;
      }

      const emailInput = document.querySelector('[name="email"]');
      if (emailInput) {
        emailInput.addEventListener('input', function() {
          this.value = this.value.trim().replace(/[\r\n\t]/g,'');
          validateEmailField(this);
          updateSubmitButton();
        });
      
        emailInput.addEventListener('blur', function() {
          this.value = this.value.trim();
          validateEmailField(this);
          updateSubmitButton();
        });
      
        emailInput.addEventListener('paste', function() {
          setTimeout(() => {
            this.value = this.value.trim().replace(/[\r\n\t]/g,'');
            validateEmailField(this);
            updateSubmitButton();
          }, 0);
        });
      }
    if (firstNameInput) {
      firstNameInput.addEventListener('input', function () { validateNameInput(firstNameInput); updateSubmitButton(); });
      firstNameInput.addEventListener('blur', function () { validateNameInput(firstNameInput); updateSubmitButton(); });
      firstNameInput.addEventListener('paste', function () { setTimeout(function () { validateNameInput(firstNameInput); updateSubmitButton(); }, 0); });
    }
    if (lastNameInput) {
      lastNameInput.addEventListener('input', function () { validateNameInput(lastNameInput); updateSubmitButton(); });
      lastNameInput.addEventListener('blur', function () { validateNameInput(lastNameInput); updateSubmitButton(); });
      lastNameInput.addEventListener('paste', function () { setTimeout(function () { validateNameInput(lastNameInput); updateSubmitButton(); }, 0); });
    }

    if (rut) {
      rut.addEventListener('input', function() {
        const raw = rut.value;
        const cleaned = cleanRut(raw);
        const formatted = formatRut(cleaned);
        if (rut.value !== formatted) {
          rut.value = formatted;
          if (typeof rut.setSelectionRange === 'function') {
            const caret = formatted.length;
            rut.setSelectionRange(caret, caret);
          }
        }
        validateRut(rut);
        updateSubmitButton();
      });

      rut.addEventListener('blur', function() {
        const raw = rut.value;
        const cleaned = cleanRut(raw);
        const formatted = formatRut(cleaned);
        rut.value = formatted;
        validateRut(rut);
        updateSubmitButton();
      });

      rut.addEventListener('paste', function(e) {
        setTimeout(function() {
          const cleaned = cleanRut(rut.value);
          const formatted = formatRut(cleaned);
          rut.value = formatted;
          validateRut(rut);
          updateSubmitButton();
        }, 0);
      });

      validateRut(rut);
    }

    // initial enable/disable
    updateSubmitButton();

    function validateForm(event) {
      // final guard: prevent submit if invalid
      if (!updateSubmitButton()) {
        event.preventDefault();
        return false;
      }
      return true;
    }

    function sanitizeRutValue(value) {
      if (!value) return '';
      const normalized = value.normalize('NFC').replace(/\s+/g, '');
      let result = '';
      for (const char of normalized) {
        if (result.length >= 9) break;
        if (/[0-9]/.test(char)) { result += char; continue; }
        if ((char === 'k' || char === 'K') && result.length === 8) { result += 'K'; }
      }
      return result;
    }

    function cleanRut(value) { 
      return sanitizeRutValue(value); 
    }

    function formatRut(value) {
      const cleaned = cleanRut(value);
      if (cleaned.length <= 1) return cleaned;
      const body = cleaned.slice(0, -1);
      const dv = cleaned.slice(-1);
      const reversed = body.split('').reverse();
      const chunks = [];
      for (let i = 0; i < reversed.length; i += 3) {
        chunks.push(reversed.slice(i, i + 3).reverse().join(''));
      }
      return chunks.reverse().join('.') + '-' + dv;
    }

    function computeDV(body) {
      let sum = 0;
      let multiplier = 2;
      for (let i = body.length - 1; i >= 0; i--) {
        sum += parseInt(body[i], 10) * multiplier;
        multiplier = multiplier === 7 ? 2 : multiplier + 1;
      }
      const remainder = 11 - (sum % 11);
      if (remainder === 11) return '0';
      if (remainder === 10) return 'K';
      return String(remainder);
    }

    function isValidRut(value) {
      const cleaned = cleanRut(value);
      if (cleaned.length < 2) return false;
      const body = cleaned.slice(0, -1);
      const dv = cleaned.slice(-1);
      if (!/^[0-9]+$/.test(body)) return false;
      return computeDV(body) === dv;
    }

    function showRutError(message) {
      rutFeedback.textContent = message;
      rutFeedback.classList.remove('d-none');
      rut.classList.add('is-invalid');
    }

    function hideRutError() {
      rutFeedback.textContent = '';
      rutFeedback.classList.add('d-none');
      rut.classList.remove('is-invalid');
    }

    function validateRut(input) {
      const cleaned = cleanRut(input.value);
      if (!cleaned) {
        showRutError('Debes rellenar este campo');
        return false;
      }
      if (!isValidRut(cleaned)) {
        showRutError('RUT inválido');
        return false;
      }
      hideRutError();
      return true;
    }

    if (rut) {
      rut.addEventListener('input', function() {
        const raw = rut.value;
        const cleaned = cleanRut(raw);
        const formatted = formatRut(cleaned);
        if (rut.value !== formatted) {
          rut.value = formatted;
          if (typeof rut.setSelectionRange === 'function') {
            const caret = formatted.length;
            rut.setSelectionRange(caret, caret);
          }
        }
        validateRut(rut);
      });

      rut.addEventListener('blur', function() {
        const raw = rut.value;
        const cleaned = cleanRut(raw);
        const formatted = formatRut(cleaned);
        rut.value = formatted;
        validateRut(rut);
      });

      rut.addEventListener('paste', function(e) {
        setTimeout(function() {
          const cleaned = cleanRut(rut.value);
          const formatted = formatRut(cleaned);
          rut.value = formatted;
          validateRut(rut);
        }, 0);
      });

      validateRut(rut);
    }
  });
</script>
<script src="{% static 'js/perfil.js' %}" defer></script>
<style>
  .profile-wrapper .card {
    border: 0;
    border-radius: 12px;
    box-shadow: var(--shadow);
    background: #fff;
  }
  .profile-wrapper .list-group-item {
    border: 0;
  }
</style>

<br><br><br><br><br><br>

{% endblock %}
