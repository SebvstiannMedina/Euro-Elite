{% extends 'base.html' %}
{% load static %}
{% block title %}Inicio - Euro Elite{% endblock %}
{% block content %}
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>

    <!-- Agregar editar producto -->

    <h1 class="mb-4">Gestión de Productos</h1>

    <!-- Formulario -->
    <form id="productForm" class="row g-3 mb-4">
        <input type="hidden" id="productId">
        <div class="col-md-3">
            <input type="text" id="productName" class="form-control" placeholder="Nombre" required>
        </div>
        <div class="col-md-3">
            <input type="text" id="productDescription" class="form-control" placeholder="Descripción" required>
        </div>
        <div class="col-md-2">
            <input type="number" id="productPrice" class="form-control" placeholder="Precio" required>
        </div>
        <div class="col-md-2">
            <input type="file" id="productImage" class="form-control" accept="image/*" required>
        </div>
        <div class="col-md-2">
            <select id="productCategory" class="form-select" required>
                <option value="">Categoría...</option>
                <option value="BMW">BMW</option>
                <option value="Audi">Audi</option>
                <option value="Mercedes">Mercedes</option>
                <option value="Herramientas">Herramientas</option>
            </select>
        </div>
        <div class="col-md-2 d-grid">
            <button type="submit" class="btn btn-success">Guardar</button>
        </div>
    </form>

    <!-- Tabla de productos -->
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Precio</th>
                <th>Categoría</th>
                <th>Imagen Producto</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="productTable"></tbody>
    </table>
{% endblock %}
    <script>
        const carritoURL = "{% url 'carrito_compras' %}";
    </script>
    <script>
        let editingIndex = null;

        // Cargar productos al iniciar
        document.addEventListener("DOMContentLoaded", loadProducts);

        // Guardar producto
        document.getElementById("productForm").addEventListener("submit", function (e) {
            e.preventDefault();

            const name = document.getElementById("productName").value;
            const description = document.getElementById("productDescription").value;
            const price = parseFloat(document.getElementById("productPrice").value);
            const category = document.getElementById("productCategory").value;
            const file = document.getElementById("productImage").files[0];

            if (!file && editingIndex === null) {
                alert("Por favor, selecciona una imagen para el producto.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (event) {
                const imageBase64 = file ? event.target.result : JSON.parse(localStorage.getItem("products"))[editingIndex].image;

                let products = JSON.parse(localStorage.getItem("products")) || [];

                const newProduct = { name, description, price, category, image: imageBase64 };

                if (editingIndex !== null) {
                    products[editingIndex] = newProduct;
                    editingIndex = null;
                } else {
                    products.push(newProduct);
                }

                localStorage.setItem("products", JSON.stringify(products));
                document.getElementById("productForm").reset();
                loadProducts();
            };

            if (file) {
                reader.readAsDataURL(file);
            } else {
                reader.onload();
            }
        });

        // Cargar productos en la tabla
        function loadProducts() {
            const products = JSON.parse(localStorage.getItem("products")) || [];
            const table = document.getElementById("productTable");
            table.innerHTML = "";

            products.forEach((p, index) => {
                const row = `
        <tr>
          <td>${p.name}</td>
          <td>${p.description}</td>
          <td>$${p.price.toLocaleString()}</td>
          <td>${p.category}</td>
          <td>
            <img src="${p.image}" alt="${p.name}" width="60" height="60" style="object-fit:cover; border-radius:5px;">
          </td>
          <td>
            <button class="btn btn-warning btn-sm" onclick="editProduct(${index})">Editar</button>
            <button class="btn btn-danger btn-sm" onclick="deleteProduct(${index})">Eliminar</button>
          </td>
        </tr>
      `;
                table.innerHTML += row;
            });
        }

        // Editar producto
        function editProduct(index) {
            const products = JSON.parse(localStorage.getItem("products")) || [];
            const product = products[index];

            document.getElementById("productName").value = product.name;
            document.getElementById("productDescription").value = product.description;
            document.getElementById("productPrice").value = product.price;
            document.getElementById("productCategory").value = product.category;

            editingIndex = index;
        }

        // Eliminar producto
        function deleteProduct(index) {
            let products = JSON.parse(localStorage.getItem("products")) || [];
            products.splice(index, 1);
            localStorage.setItem("products", JSON.stringify(products));
            loadProducts();
        }
    </script>
    <script src="{% static 'js/main.js' %}?v=2"></script>
</body>

</html>