{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load i18n %}
{% load custom_filters %}

{% block title %}Productos - Euro Elite{% endblock %}

{% block content %}

<!-- FILTROS -->
<section class="py-4 bg-light">
  <div class="container d-flex flex-wrap justify-content-center gap-3">
    <input type="text" id="searchInput" placeholder="Buscar producto..." 
           class="form-control w-auto" onkeyup="searchProducts()">

    <select id="categoryFilter" class="form-select w-auto" onchange="filterProducts()">
      <option value="all">Todas</option>
      {% for cat in categorias %}
        <option value="{{ cat.slug }}">{{ cat.nombre }}</option>
      {% endfor %}
    </select>
  </div>
</section>

<!-- PRODUCTOS -->
<section class="featured-offers" id="offers" style="margin-bottom: 8rem;">
  <h2 class="section-title">Productos en Venta</h2>
  <div class="offers-grid">
    {% for p in productos %}
      <div class="product-card" data-category="{{ p.categoria.slug|default:'sin-categoria' }}">

        {% if p.promocion_vigente %}
          <div class="offer-badge">
            {% if p.promocion_vigente.tipo == 'PORCENTAJE' %}
              -{{ p.promocion_vigente.valor|floatformat:0 }}%
            {% else %}
              Oferta
            {% endif %}
          </div>
        {% endif %}

        <div class="offer-image">
          {% if p.imagen %}
            <img src="{{ p.imagen.url }}" alt="{{ p.nombre }}">
          {% else %}
            <img src="{% static 'img/no-image.png' %}" alt="Sin imagen">
          {% endif %}
        </div>

        <div class="offer-content">
          <h3 class="product-title">{{ p.nombre }}</h3>
          <p class="product-description">{{ p.descripcion|truncatewords:20 }}</p>

          <div class="offer-price">
            {% if p.promocion_vigente %}
              <span class="current-price">${{ p.precio_con_descuento|miles_chilenos }}</span>
              <span class="original-price">${{ p.precio|miles_chilenos }}</span>
            {% else %}
              <span class="current-price">${{ p.precio|miles_chilenos }}</span>
            {% endif %}
          </div>

          <div class="product-actions">
            <!-- Bot칩n carrito -->
            <button class="btn btn-primary"
                    onclick="addToCart('{{ p.nombre|escapejs }}',
                                        '{{ p.precio_con_descuento|default:p.precio }}',
                                        '{{ p.id }}',
                                        '{{ p.stock }}')">
              <i class="fas fa-shopping-cart"></i> A침adir al Carrito
            </button>

            <!-- Bot칩n detalle -->
            {% if p.imagen %}
              <button class="btn btn-outline-primary" onclick="showProductDetailFromButton(this)"
                      data-name="{{ p.nombre|escapejs }}"
                      data-description="{{ p.descripcion|default_if_none:''|escapejs }}"
                      data-price="{{ p.precio }}"
                      data-image="{{ p.imagen.url }}">Ver detalle</button>
            {% else %}
              <button class="btn btn-outline-primary" onclick="showProductDetailFromButton(this)"
                      data-name="{{ p.nombre|escapejs }}"
                      data-description="{{ p.descripcion|default_if_none:''|escapejs }}"
                      data-price="{{ p.precio }}"
                      data-image="{% static 'img/no-image.png' %}">Ver detalle</button>
            {% endif %}
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-center">No hay productos disponibles.</p>
    {% endfor %}
  </div>
</section>

{% endblock %}

<!--El const carrito URL es para que la p치gina de carrito cargue la URL correcta-->
<script>
  const carritoURL = "{% url 'carrito_compras' %}";
</script>

<script src="{% static 'js/filtro.js' %}"></script>
<script src="{% static 'js/main.js' %}?v=2"></script>