{% extends 'base.html' %}
{% load humanize %}
{% block title %}Revisi√≥n de Veh√≠culos - Euro Elite{% endblock %}

{% block content %}
<div class="container py-5">
  <h2 class="text-center mb-4">üõ† Revisi√≥n de Veh√≠culos Publicados</h2>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <div class="row">
    {% for v in pendientes %}
      <div class="col-md-6 mb-4">
        <div class="card shadow-sm border-0 rounded-4">
          {% if v.imagen %}
            <img src="{{ v.imagen.url }}" class="card-img-top rounded-top-4" alt="{{ v.marca }}">
          {% endif %}
          <div class="card-body">
            <h5 class="card-title">{{ v.marca }} {{ v.modelo }} ({{ v.a√±o }})</h5>
            <p class="text-muted mb-1">Publicado por: <strong>{{ v.usuario.username }}</strong></p>
            <ul class="list-unstyled mb-3">
              <li>‚öôÔ∏è <strong>Transmisi√≥n:</strong> {{ v.get_transmision_display }}</li>
              <li>‚õΩ <strong>Combustible:</strong> {{ v.get_combustible_display }}</li>
              <li>üìè <strong>Kilometraje:</strong> {{ v.kilometraje|intcomma }} km</li>
            </ul>
            <p class="fw-bold text-success mb-2">${{ v.precio|floatformat:0 }}</p>
            <p>{{ v.descripcion|truncatechars:120 }}</p>

            <div class="d-flex justify-content-between mt-3">
              <a href="{% url 'aprobar_vehiculo' v.id %}" class="btn btn-success">
                ‚úÖ Aprobar
              </a>
              <a href="{% url 'rechazar_vehiculo' v.id %}" class="btn btn-danger">
                ‚ùå Rechazar
              </a>
            </div>
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-center mt-5">No hay veh√≠culos pendientes de revisi√≥n.</p>
    {% endfor %}
  </div>

  <hr class="my-5">

  <h3 class="text-center mb-3">‚úÖ Veh√≠culos Aprobados</h3>
  <div class="row">
    {% for v in aprobados %}
      <div class="col-md-4 mb-4">
        <div class="card border-0 shadow-sm rounded-4">
          {% if v.imagen %}
            <img src="{{ v.imagen.url }}" class="card-img-top rounded-top-4" alt="{{ v.marca }}">
          {% endif %}
          <div class="card-body">
            <h5 class="text-center mb-2">{{ v.marca }} {{ v.modelo }} ({{ v.a√±o }})</h5>
            <p class="text-center mb-2">‚öôÔ∏è {{ v.get_transmision_display }} | ‚õΩ {{ v.get_combustible_display }}</p>
            <p class="text-success fw-bold text-center mb-3">${{ v.precio|floatformat:0 }}</p>
            
            <!-- Estado del Veh√≠culo -->
            <div class="mb-3">
              <label class="form-label small fw-bold">Estado:</label>
              <div class="d-flex gap-2">
                <select class="form-select form-select-sm" id="estado-{{ v.id }}" onchange="cambiarEstado({{ v.id }})">
                  <option value="aprobado" {% if v.estado == 'aprobado' %}selected{% endif %}>‚úÖ Aprobado</option>
                  <option value="vendido" {% if v.estado == 'vendido' %}selected{% endif %}>üí∞ Vendido</option>
                  <option value="oculto" {% if v.estado == 'oculto' %}selected{% endif %}>üîí Oculto</option>
                  <option value="rechazado" {% if v.estado == 'rechazado' %}selected{% endif %}>‚ùå Rechazar</option>
                </select>
              </div>
            </div>
            
            <div class="text-center">
              <a href="{% url 'vehiculo_detalle' v.id %}" class="btn btn-sm btn-outline-primary" target="_blank">
                <i class="fas fa-eye"></i> Ver Detalle
              </a>
            </div>
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-center">No hay veh√≠culos aprobados a√∫n.</p>
    {% endfor %}
  </div>

  <!-- Veh√≠culos Vendidos -->
  <hr class="my-5">
  <h3 class="text-center mb-3">üí∞ Veh√≠culos Vendidos</h3>
  <div class="row">
    {% for v in vendidos %}
      <div class="col-md-4 mb-4">
        <div class="card border-0 shadow-sm rounded-4" style="opacity: 0.7;">
          {% if v.imagen %}
            <img src="{{ v.imagen.url }}" class="card-img-top rounded-top-4" alt="{{ v.marca }}">
          {% endif %}
          <div class="card-body">
            <h5 class="text-center mb-2">{{ v.marca }} {{ v.modelo }} ({{ v.a√±o }})</h5>
            <p class="text-center mb-2">‚öôÔ∏è {{ v.get_transmision_display }} | ‚õΩ {{ v.get_combustible_display }}</p>
            <p class="text-success fw-bold text-center mb-3">${{ v.precio|floatformat:0 }}</p>
            <span class="badge bg-success w-100">VENDIDO</span>
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-center">No hay veh√≠culos vendidos a√∫n.</p>
    {% endfor %}
  </div>

  <!-- Veh√≠culos Ocultos -->
  <hr class="my-5">
  <h3 class="text-center mb-3">üîí Veh√≠culos Ocultos</h3>
  <div class="row">
    {% for v in ocultos %}
      <div class="col-md-4 mb-4">
        <div class="card border-0 shadow-sm rounded-4" style="opacity: 0.6;">
          {% if v.imagen %}
            <img src="{{ v.imagen.url }}" class="card-img-top rounded-top-4" alt="{{ v.marca }}">
          {% endif %}
          <div class="card-body">
            <h5 class="text-center mb-2">{{ v.marca }} {{ v.modelo }} ({{ v.a√±o }})</h5>
            <p class="text-center mb-2">‚öôÔ∏è {{ v.get_transmision_display }} | ‚õΩ {{ v.get_combustible_display }}</p>
            <p class="text-success fw-bold text-center mb-3">${{ v.precio|floatformat:0 }}</p>
            
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-success flex-fill" onclick="cambiarEstadoDirecto({{ v.id }}, 'aprobado')">
                Publicar
              </button>
              <button class="btn btn-sm btn-danger flex-fill" onclick="cambiarEstadoDirecto({{ v.id }}, 'rechazado')">
                Eliminar
              </button>
            </div>
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-center">No hay veh√≠culos ocultos.</p>
    {% endfor %}
  </div>
</div>

<script>
function cambiarEstado(vehiculoId) {
  const nuevoEstado = document.getElementById(`estado-${vehiculoId}`).value;
  
  if (confirm(`¬øEst√°s seguro de cambiar el estado del veh√≠culo?`)) {
    fetch(`/cambiar_estado_vehiculo/${vehiculoId}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ estado: nuevoEstado })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Estado actualizado correctamente');
        location.reload();
      } else {
        alert('Error al actualizar: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error al actualizar el estado');
    });
  } else {
    // Revertir el select al estado original
    location.reload();
  }
}

function cambiarEstadoDirecto(vehiculoId, nuevoEstado) {
  const mensaje = nuevoEstado === 'aprobado' ? '¬øPublicar este veh√≠culo?' : '¬øEliminar este veh√≠culo?';
  
  if (confirm(mensaje)) {
    fetch(`/cambiar_estado_vehiculo/${vehiculoId}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ estado: nuevoEstado })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Estado actualizado correctamente');
        location.reload();
      } else {
        alert('Error al actualizar: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error al actualizar el estado');
    });
  }
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>

{% endblock %}
