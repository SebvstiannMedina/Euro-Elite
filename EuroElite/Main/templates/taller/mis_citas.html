{% extends 'base.html' %}
{% load static %}
{% load tz %}
{% block title %}Mis citas - Euro Elite{% endblock %}
{% block content %}

<!-- Espaciado superior -->
<div class="container my-5 profile-wrapper">
  <div class="row">
    <!-- Sidebar -->
    <aside class="col-12 col-md-3 mb-4">
      <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body">
          <h5 class="mb-1">Hola, {{ user.first_name }}</h5>
          <p class="text-muted" style="font-size: .9rem;">Accede a toda la información de tu perfil</p>
          <div class="list-group list-group-flush mt-3">
            <a href="{% url 'perfil' %}" class="list-group-item list-group-item-action">
              <i class="fas fa-id-card me-2"></i> Mis datos
            </a>
            <a href="{% url 'password_reset' %}" class="list-group-item list-group-item-action">
              <i class="fas fa-lock me-2"></i> Contraseña
            </a>
            <a href="{% url 'mis_citas' %}" class="list-group-item list-group-item-action active">
              <i class="fas fa-calendar-alt me-2"></i> Mis citas
            </a>
            <a href="{% url 'mis_pedidos' %}" class="list-group-item list-group-item-action">
              <i class="fas fa-shopping-bag me-2"></i> Mis compras
            </a>
          </div>
        </div>
      </div>
    </aside>

    <!-- Contenido principal -->
    <section class="col-12 col-md-9" id="ordersSection">
      <h3 class="mb-4">Mis citas</h3>

      <!-- Mostrar mensajes -->
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}

      <div class="card shadow-sm p-4 border-0 rounded-4 bg-white">
        {% if citas %}
          {% for c in citas %}
            <div class="order-card shadow-sm mb-4 p-3 rounded-3 border">
              <div class="row align-items-center gy-3">
                <!-- Izquierda -->
                <div class="col-12 col-md-8 d-flex align-items-start">
                  <div class="order-image-wrap flex-shrink-0">
                    <img src="{% static 'img/LogoApp.png' %}" alt="Cita" class="order-image">
                  </div>
                  <div class="ms-3 flex-grow-1">
                    <!-- Estado -->
                    <div class="small fw-semibold mb-1 
                      {% if c.estado == 'COMPLETADA' %}text-success
                      {% elif c.estado == 'CANCELADA' %}text-danger
                      {% elif c.estado == 'EN_PROCESO' %}text-warning
                      {% else %}text-primary{% endif %}">
                      {{ c.get_estado_display }}
                    </div>

                    <!-- Fecha y hora -->
                    <div class="order-title">
                      Cita el {{ c.bloque.inicio|localtime|date:"j \\d\\e F" }} a las {{ c.bloque.inicio|localtime|date:"H:i" }}
                    </div>

                    <!-- Servicio -->
                    <div class="order-subtitle fw-semibold text-dark">{{ c.servicio.nombre }}</div>

                    <!-- Tipo de atención -->
                    {% if c.a_domicilio %}
                      <div class="order-subtitle">
                        <i class="fas fa-truck text-primary"></i>
                        A domicilio ({{ c.direccion_domicilio|default:"Sin dirección" }})
                      </div>
                    {% else %}
                      <div class="order-subtitle">
                        <i class="fas fa-warehouse text-secondary"></i> En taller
                      </div>
                    {% endif %}
                  </div>
                </div>

                <!-- Acciones -->
                <div class="col-12 col-md-4 text-md-end">
                  {% if c.estado == 'RESERVADA' %}
                    <a class="btn btn-outline-danger btn-sm px-3" href="{% url 'anular_cita' c.id %}?next={{ request.get_full_path|urlencode }}">
                      <i class="fas fa-times-circle me-1"></i> Anular
                    </a>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <!-- Estado vacío -->
          <div class="empty-state text-center p-5 bg-white border rounded-3">
            <img src="{% static 'img/LogoApp.png' %}" alt="Euro Elite" style="width:72px;height:72px;opacity:.7;">
            <h5 class="mt-3 mb-1">Aún no tienes citas agendadas</h5>
            <p class="text-muted mb-3">Cuando agendes un servicio, verás tus citas aquí.</p>
            <a href="{% url 'agendar' %}" class="btn btn-primary btn-sm">Ver servicios</a>
          </div>
        {% endif %}
      </div>
    </section>
  </div>
</div>

<style>
  /* === Tarjetas de perfil y citas === */
  .profile-wrapper .card {
    border: none;
    border-radius: 12px;
    background: #fff;
    box-shadow: var(--shadow, 0 2px 10px rgba(0,0,0,0.08));
  }
  .list-group-item.active {
    background-color: #0d6efd !important;
    color: #fff !important;
    font-weight: 600;
  }
  .order-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .order-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.08);
  }
  .order-image {
    width: 72px;
    height: 72px;
    object-fit: contain;
    border-radius: 8px;
    background: #f8fafc;
  }
  .order-title {
    font-weight: 600;
    font-size: 1.05rem;
    color: #111827;
  }
  .order-subtitle {
    color: #6b7280;
    font-size: .9rem;
  }
  .empty-state img {
    opacity: 0.6;
  }
</style>

{% endblock %}
